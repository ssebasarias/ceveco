<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Favoritos - Ceveco</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="../assets/img/logo.png">
    <!-- ✨ Sistema CSS Centralizado Profesional ✨ -->
    <link rel="stylesheet" href="../assets/css/main.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: { DEFAULT: 'var(--brand-red)', dark: '#d91b10', light: '#ff4d4d' },
                        secondary: { DEFAULT: 'var(--brand-blue-royal)', dark: '#002a5c', light: '#3366cc' },
                        accent: { DEFAULT: '#FFD23F', dark: '#E6BD38' },
                        dark: 'var(--brand-navy)',
                        white: 'var(--surface-white)',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        heading: ['Montserrat', 'sans-serif'],
                    }
                }
            }
        }
    </script>
</head>

<body class="bg-gray-50 text-gray-800 font-sans antialiased flex flex-col min-h-screen">

    <!-- Sticky Header -->
    <div id="navbar-root"></div>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto px-4 py-8">
        <div class="flex items-center gap-3 mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Mis Favoritos</h1>
            <span id="fav-count" class="bg-gray-200 text-gray-700 px-3 py-1 rounded-full text-sm font-medium">0
                productos</span>
        </div>

        <!-- Loading State -->
        <div id="loading-state" class="flex justify-center py-20">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="hidden text-center py-16 bg-white rounded-2xl shadow-sm border border-gray-100">
            <div class="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="heart" class="w-8 h-8"></i>
            </div>
            <h2 class="text-xl font-bold text-gray-900 mb-2">Aún no tienes favoritos</h2>
            <p class="text-gray-500 mb-6">Guarda los productos que te gustan para encontrarlos más tarde.</p>
            <a href="productos.html"
                class="inline-block px-6 py-3 bg-primary text-white font-semibold rounded-lg hover:bg-primary-dark transition-colors">
                Explorar Productos
            </a>
        </div>

        <!-- Grid de Favoritos -->
        <div id="favorites-grid" class="hidden grid grid-cols-2 lg:grid-cols-4 gap-3 md:gap-6">
            <!-- Cards will be injected here -->
        </div>
    </main>

    <!-- Footer -->
    <div id="footer-root"></div>

    <!-- Scripts -->
    <script src="../assets/js/config.js"></script>
    <!-- Modern Core Services -->
    <script src="../assets/js/utils/constants.js"></script>
    <script src="../assets/js/utils/helpers.js"></script>
    <script src="../assets/js/utils/storage.js"></script>
    <script src="../assets/js/config.js"></script>
    <script src="../assets/js/api/client.js"></script>
    <script src="../assets/js/services/auth.service.js"></script>
    <script src="../assets/js/services/products.service.js"></script>
    <script src="../assets/js/services/favorites.service.js"></script>
    <script src="../assets/js/core.js"></script>

    <!-- Legacy Bridge -->
    <script>
        window.Utils = window.Helpers;
        window.formatPrice = window.Helpers.formatPrice;
    </script>
    <script type="module" src="../assets/js/auth/index.js"></script>
    <script src="../assets/js/components/cart-sidebar.js"></script>
    <script src="../assets/js/main-app.js" defer></script>

    <script type="module">
        // Already loaded via global services
        async function loadFavorites() {
            const container = document.getElementById('favorites-grid');
            const loading = document.getElementById('loading-state');
            const empty = document.getElementById('empty-state');
            const counter = document.getElementById('fav-count');

            try {
                // Verificar auth (Compatibilidad con sistema nuevo y viejo)
                const isAuth = window.AuthService?.isAuthenticated() ||
                    (typeof window.isUserAuthenticated === 'function' && window.isUserAuthenticated());

                if (!isAuth) {
                    window.location.href = 'login.html';
                    return;
                }

                // Usar nuevo servicio
                const data = await window.FavoritesService.getAll();
                // Nota: getAll devuelve array data directamente según mi Service implementation? No, getAll retorna response.
                // Revisemos FavoritesService implementation en paso 156.
                // "if (response.success) { return response.data; } return [];"
                // Así que retorna el ARRAY directamente.

                // Adaptar lógica que espera { success: true, data: [] }
                // O ajustar FavoritesService.
                // Ajustaré aquí asuminedo data es el array.
                const favorites = data;

                if (favorites && favorites.length > 0) {
                    container.classList.remove('hidden');
                    empty.classList.add('hidden');

                    // Update counter
                    counter.textContent = `${favorites.length} producto${favorites.length !== 1 ? 's' : ''}`;

                    // Render cards
                    const cardsHtml = (await Promise.all(favorites.map(async (p) => {
                        return await renderProductCard(p);
                    }))).join('');

                    container.innerHTML = cardsHtml;
                    lucide.createIcons();
                } else {
                    container.classList.add('hidden');
                    empty.classList.remove('hidden');
                    counter.textContent = '0 productos';
                }

            } catch (error) {
                console.error('Error al cargar favoritos:', error);
                // Mostrar error genérico o empty
                empty.classList.remove('hidden');
            } finally {
                if (loading) {
                    loading.classList.remove('flex');
                    loading.classList.add('hidden');
                }
            }
        }


        document.addEventListener('DOMContentLoaded', async () => {
            await loadFavorites();
            // Import and init logic to ensure global state matches
            import('../assets/js/favorites/index.js').then(module => {
                setTimeout(() => {
                    if (window.updateFavoritesUI) window.updateFavoritesUI();
                }, 100);
            });
        });

        // Solución para navegar Atrás/Adelante y recargar datos (BFCache)
        window.addEventListener('pageshow', async (event) => {
            // Si la página se restaura desde la caché (bfcache)
            if (event.persisted) {
                console.log('Restaurado desde caché, recargando favoritos...');
                await loadFavorites();

                // Recargar el estado global de favoritos (IDs) para mantener sincronía
                if (window.initFavorites) await window.initFavorites();

                // Actualizar UI global si es necesario
                if (window.updateFavoritesUI) window.updateFavoritesUI();
            }
        });
    </script>
</body>

</html>