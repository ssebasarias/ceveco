<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Cargando producto... - Ceveco</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="../assets/img/logo.png">
    <!-- ✨ Sistema CSS Centralizado Profesional ✨ -->
    <link rel="stylesheet" href="../assets/css/main.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: { DEFAULT: 'var(--brand-red)', dark: '#d91b10', light: '#ff4d4d' },
                        secondary: { DEFAULT: 'var(--brand-blue-royal)', dark: '#002a5c', light: '#3366cc' },
                        accent: { DEFAULT: '#FFD23F', dark: '#E6BD38' },
                        dark: 'var(--brand-navy)',
                        white: 'var(--surface-white)',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        heading: ['Montserrat', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .thumbnail.active {
            border-color: #0056b3;
        }

        .thumbnail {
            opacity: 0.7;
            transition: all 0.3s;
        }

        .thumbnail:hover,
        .thumbnail.active {
            opacity: 1;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800 font-sans antialiased">

    <!-- Sticky Header -->
    <!-- Sticky Header -->
    <div id="navbar-root"></div>

    <!-- Breadcrumb -->
    <div class="bg-white border-b border-gray-200">
        <div class="container mx-auto px-4 py-3">
            <nav class="flex items-center gap-2 text-sm text-gray-600">
                <a href="index.html" class="hover:text-primary transition-colors">Inicio</a>
                <i data-lucide="chevron-right" class="w-4 h-4"></i>
                <a href="#" id="breadcrumb-category" class="hover:text-primary transition-colors">Categoría</a>
                <i data-lucide="chevron-right" class="w-4 h-4"></i>
                <span id="breadcrumb-product" class="text-gray-900 font-medium">Producto</span>
            </nav>
        </div>
    </div>

    <!-- Product Detail -->
    <main class="container mx-auto px-4 py-12">
        <!-- Loading State -->
        <div id="loading-state" class="flex justify-center py-20">
            <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-primary"></div>
        </div>

        <!-- Error State -->
        <div id="error-state" class="hidden text-center py-20">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Producto no encontrado</h2>
            <p class="text-gray-600 mb-8">Lo sentimos, no pudimos encontrar el producto que buscas.</p>
            <a href="index.html"
                class="px-6 py-3 bg-primary text-white font-semibold rounded-lg hover:bg-primary-dark transition-colors">
                Volver al Inicio
            </a>
        </div>

        <div id="product-content" class="hidden grid grid-cols-1 lg:grid-cols-2 gap-12 mb-16">

            <!-- Product Images -->
            <div class="space-y-4">
                <!-- Main Image -->
                <div
                    class="bg-white rounded-2xl border border-gray-200 p-8 aspect-square flex items-center justify-center relative overflow-hidden group">
                    <img id="main-image" src="" alt="Producto"
                        class="max-w-full max-h-full object-contain transition-transform duration-500 group-hover:scale-110">
                    <div id="product-badge" class="absolute top-4 left-4"></div>
                </div>

                <!-- Thumbnails -->
                <div id="thumbnails-container" class="grid grid-cols-4 gap-3">
                    <!-- Thumbnails will be injected here -->
                </div>
            </div>

            <!-- Product Info -->
            <div class="space-y-6">
                <!-- Brand & Title -->
                <div>
                    <span id="product-brand"
                        class="inline-block px-3 py-1 bg-blue-50 text-primary text-xs font-bold uppercase tracking-wider rounded-full mb-3">MARCA</span>
                    <h1 id="product-name" class="text-3xl md:text-4xl font-bold text-gray-900 mb-2">Nombre del Producto
                    </h1>
                    <p id="product-short-desc" class="text-gray-600">Descripción corta del producto</p>
                </div>

                <!-- Rating & Reviews -->
                <div class="flex items-center gap-4 pb-4 border-b border-gray-200">
                    <div class="flex items-center gap-1" id="rating-stars">
                        <!-- Stars injected by JS -->
                    </div>
                    <span id="reviews-count" class="text-sm text-gray-600">(0 reseñas)</span>
                </div>

                <!-- Price -->
                <div class="py-4 border-b border-gray-200">
                    <div class="flex items-baseline gap-3 mb-2">
                        <span id="product-price" class="text-4xl font-bold text-gray-900">$0</span>
                        <span id="product-old-price" class="text-xl text-gray-400 line-through hidden">$0</span>
                    </div>
                    <div class="flex items-center gap-2 text-green-600">
                        <i data-lucide="check-circle" class="w-5 h-5"></i>
                        <span id="stock-status" class="font-medium">Disponible - Envío gratis</span>
                    </div>
                </div>

                <!-- Key Features -->
                <div class="space-y-3">
                    <h3 class="font-bold text-gray-900">Características principales:</h3>
                    <ul id="product-features" class="space-y-2">
                        <!-- Features injected by JS -->
                    </ul>
                </div>

                <!-- Actions -->
                <div class="space-y-3 pt-4">
                    <!-- Quantity & Add to Cart -->
                    <div class="flex flex-col sm:flex-row gap-3">
                        <div
                            class="flex items-center justify-center border-2 border-gray-200 rounded-lg overflow-hidden w-full sm:w-auto">
                            <button onclick="updateQuantity(-1)"
                                class="px-3 py-2 md:px-4 md:py-3 hover:bg-gray-50 transition-colors">
                                <i data-lucide="minus" class="w-4 h-4 md:w-5 md:h-5"></i>
                            </button>
                            <input type="number" id="quantity-input" value="1" min="1"
                                class="w-16 text-center border-x-2 border-gray-200 py-2 md:py-3 focus:outline-none bg-white text-sm md:text-base"
                                readonly>
                            <button onclick="updateQuantity(1)"
                                class="px-3 py-2 md:px-4 md:py-3 hover:bg-gray-50 transition-colors">
                                <i data-lucide="plus" class="w-4 h-4 md:w-5 md:h-5"></i>
                            </button>
                        </div>
                        <button id="add-to-cart-btn"
                            class="flex-1 bg-primary text-white font-bold py-3 px-6 rounded-lg hover:bg-primary-dark transition-all transform hover:scale-105 flex items-center justify-center gap-2 text-sm md:text-base shadow-sm">
                            <i data-lucide="shopping-cart" class="w-4 h-4 md:w-5 md:h-5"></i>
                            Agregar al Carrito
                        </button>
                    </div>

                    <!-- WhatsApp Contact -->
                    <a id="whatsapp-btn" href="#" target="_blank"
                        class="w-full bg-green-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-600 transition-all flex items-center justify-center gap-2 text-sm md:text-base shadow-sm">
                        <i data-lucide="message-circle" class="w-4 h-4 md:w-5 md:h-5"></i>
                        Contactar Asesor por WhatsApp
                    </a>

                    <!-- Wishlist -->
                    <button id="detail-fav-btn"
                        class="w-full border-2 border-gray-200 text-gray-700 font-semibold py-3 px-6 rounded-lg hover:bg-gray-50 hover:border-gray-300 hover:text-gray-900 transition-all flex items-center justify-center gap-2 btn-favorite text-sm md:text-base"
                        onclick="handleToggleFavorite(this, currentProduct.id_producto, event)">
                        <i data-lucide="heart" class="w-4 h-4 md:w-5 md:h-5 transition-colors"></i>
                        <span id="fav-text">Agregar a Favoritos</span>
                    </button>
                </div>

                <!-- Guarantees -->
                <div class="grid grid-cols-3 gap-4 pt-6 border-t border-gray-200">
                    <div class="text-center">
                        <div class="w-12 h-12 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-2">
                            <i data-lucide="truck" class="w-6 h-6 text-primary"></i>
                        </div>
                        <p class="text-xs font-medium text-gray-700">Envío Gratis</p>
                    </div>
                    <div class="text-center">
                        <div class="w-12 h-12 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-2">
                            <i data-lucide="shield-check" class="w-6 h-6 text-primary"></i>
                        </div>
                        <p class="text-xs font-medium text-gray-700">Garantía 1 Año</p>
                    </div>
                    <div class="text-center">
                        <div class="w-12 h-12 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-2">
                            <i data-lucide="rotate-ccw" class="w-6 h-6 text-primary"></i>
                        </div>
                        <p class="text-xs font-medium text-gray-700">Devolución 30 días</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs: Description & Specs -->
        <div id="product-details-tabs" class="hidden mb-16 bg-white rounded-xl p-8 shadow-sm border border-gray-100">
            <div class="border-b border-gray-200 mb-8">
                <nav class="flex gap-8">
                    <button onclick="switchTab('description')" id="tab-description"
                        class="tab-button active pb-4 px-2 font-semibold text-primary border-b-2 border-primary transition-colors">
                        Descripción
                    </button>
                    <button onclick="switchTab('specs')" id="tab-specs"
                        class="tab-button pb-4 px-2 font-semibold text-gray-600 border-b-2 border-transparent hover:text-primary transition-colors">
                        Ficha Técnica
                    </button>
                </nav>
            </div>

            <!-- Description Tab -->
            <div id="content-description" class="tab-content">
                <div class="prose max-w-none text-gray-700" id="full-description">
                    <!-- Description injected by JS -->
                </div>
            </div>

            <!-- Specs Tab -->
            <div id="content-specs" class="tab-content hidden">
                <h3 class="text-2xl font-bold text-gray-900 mb-6">Especificaciones Técnicas</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="specs-container">
                    <!-- Specs injected by JS -->
                </div>
            </div>
        </div>

        <!-- Related Products -->
        <div id="related-products-section" class="hidden">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-2xl font-bold text-gray-900">Productos Relacionados</h2>
                <a href="productos.html" class="text-primary font-semibold hover:underline flex items-center gap-2">
                    Ver todos <i data-lucide="arrow-right" class="w-4 h-4"></i>
                </a>
            </div>
            <div id="related-products" class="grid grid-cols-2 lg:grid-cols-4 gap-3 md:gap-6">
                <!-- Related products will be rendered by JS -->
            </div>
        </div>
    </main>

    <!-- Footer -->
    <!-- Footer -->
    <div id="footer-root"></div>

    <!-- Cart Sidebar (Injected by main.js) -->

    <!-- Scripts -->
    <script src="../assets/js/config.js"></script>
    <!-- Modern Core Services -->
    <script src="../assets/js/utils/constants.js"></script>
    <script src="../assets/js/utils/helpers.js"></script>
    <script src="../assets/js/utils/storage.js"></script>
    <script src="../assets/js/config.js"></script>
    <script src="../assets/js/api/client.js"></script>
    <script src="../assets/js/services/auth.service.js"></script>
    <script src="../assets/js/services/products.service.js"></script>
    <script src="../assets/js/services/favorites.service.js"></script>
    <script src="../assets/js/core.js"></script>

    <!-- Legacy Compatibility Bridge -->
    <script>
        window.Utils = window.Helpers;
        window.formatPrice = window.Helpers.formatPrice;
    </script>
    <script src="../assets/js/components/cart-sidebar.js"></script>
    <script type="module" src="../assets/js/auth/index.js"></script>
    <script type="module" src="../assets/js/favorites/index.js"></script>
    <script src="../assets/js/app.js"></script>

    <script>
        // Inicializar iconos Lucide
        lucide.createIcons();

        // Variables globales para el producto actual
        let currentProduct = null;
        let currentQuantity = 1;
        let currentImageIndex = 0;

        // Función de búsqueda
        function handleSearch() {
            const query = document.getElementById('search-input').value;
            if (query) {
                window.location.href = `productos.html?q=${encodeURIComponent(query)}`;
            }
        }

        // Obtener ID del producto de la URL
        function getProductIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get('id');
        }

        // Cargar detalles del producto
        async function loadProductDetails() {
            const productId = getProductIdFromUrl();

            if (!productId) {
                showError();
                return;
            }

            try {
                const response = await window.ProductService.getById(productId);

                if (response.success && response.data) {
                    currentProduct = response.data;
                    renderProduct(currentProduct);
                    loadRelatedProducts(currentProduct.id_producto);
                } else {
                    showError();
                }
            } catch (error) {
                console.error('Error al cargar producto:', error);
                showError();
            } finally {
                // Ocultar loading siempre (remove flex to avoid conflict)
                const loader = document.getElementById('loading-state');
                if (loader) {
                    loader.classList.remove('flex');
                    loader.classList.add('hidden');
                }
            }
        }

        // Renderizar información del producto
        function renderProduct(product) {
            // Mostrar contenido (el loading se oculta en finally)
            document.getElementById('product-content').classList.remove('hidden');
            document.getElementById('product-details-tabs').classList.remove('hidden');
            document.getElementById('related-products-section').classList.remove('hidden');

            // Título y Meta
            document.title = `${product.nombre} - Ceveco`;
            document.getElementById('page-title').textContent = `${product.nombre} - Ceveco`;

            // Breadcrumbs
            const breadCategory = document.getElementById('breadcrumb-category');
            breadCategory.textContent = product.categoria;
            breadCategory.href = `productos.html?categoria=${product.categoria_slug}`;
            document.getElementById('breadcrumb-product').textContent = product.nombre;

            // Info básica
            document.getElementById('product-brand').textContent = product.marca;
            document.getElementById('product-name').textContent = product.nombre;
            document.getElementById('product-short-desc').textContent = product.descripcion_corta || '';

            // Precios
            document.getElementById('product-price').textContent = Utils.formatPrice(product.precio_actual);
            if (product.precio_anterior) {
                const oldPriceEl = document.getElementById('product-old-price');
                oldPriceEl.textContent = Utils.formatPrice(product.precio_anterior);
                oldPriceEl.classList.remove('hidden');
            }

            // Badge
            if (product.badge) {
                const badgeContainer = document.getElementById('product-badge');
                badgeContainer.innerHTML = `<span class="bg-primary text-white text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wide shadow-sm">${product.badge}</span>`;
            }

            // Stock
            const stockStatus = document.getElementById('stock-status');
            if (product.stock > 0) {
                stockStatus.textContent = `Disponible (${product.stock} unidades) - Envío gratis`;
                stockStatus.parentElement.classList.add('text-green-600');
            } else {
                stockStatus.textContent = 'Agotado';
                stockStatus.parentElement.classList.remove('text-green-600');
                stockStatus.parentElement.classList.add('text-red-600');
                document.querySelector('.lucide-check-circle').setAttribute('data-lucide', 'x-circle');
                document.getElementById('add-to-cart-btn').disabled = true;
                document.getElementById('add-to-cart-btn').classList.add('opacity-50', 'cursor-not-allowed');
                document.getElementById('add-to-cart-btn').textContent = 'Agotado';
            }

            // Imágenes
            const mainImage = document.getElementById('main-image');
            // Usar imagen principal o placeholder
            const mainImgUrl = product.imagen_principal || 'https://via.placeholder.com/600x600?text=Sin+Imagen';
            mainImage.src = mainImgUrl;

            // Renderizar thumbnails
            const thumbnailsContainer = document.getElementById('thumbnails-container');
            let images = product.imagenes || [];

            // Si no hay imágenes en el array pero hay imagen principal, crear array
            if (images.length === 0 && product.imagen_principal) {
                images = [{ url: product.imagen_principal }];
            }

            if (images.length > 0) {
                thumbnailsContainer.innerHTML = images.map((img, index) => `
                    <button onclick="changeImage('${img.url}', ${index})"
                        class="thumbnail ${index === 0 ? 'active border-primary' : 'border-gray-200'} border-2 rounded-lg overflow-hidden aspect-square hover:border-primary transition-all">
                        <img src="${img.url}" alt="Vista ${index + 1}" class="w-full h-full object-contain p-1">
                    </button>
                `).join('');
            }

            // Descripción larga
            document.getElementById('full-description').innerHTML = product.descripcion_larga || `<p>${product.descripcion_corta}</p>`;

            // Especificaciones
            const specsContainer = document.getElementById('specs-container');
            if (product.especificaciones && product.especificaciones.length > 0) {
                // Agrupar especificaciones (si tuvieran grupo, aquí asumimos lista plana por ahora o adaptamos)
                const specsHtml = product.especificaciones.map(spec => `
                    <div class="flex justify-between py-3 border-b border-gray-200">
                        <span class="font-semibold text-gray-700">${spec.nombre}:</span>
                        <span class="text-gray-600">${spec.valor}</span>
                    </div>
                `).join('');

                // Dividir en dos columnas si hay muchas
                const midPoint = Math.ceil(product.especificaciones.length / 2);
                const col1Specs = product.especificaciones.slice(0, midPoint);
                const col2Specs = product.especificaciones.slice(midPoint);

                specsContainer.innerHTML = `
                    <div class="space-y-3">
                        ${col1Specs.map(spec => `
                            <div class="flex justify-between py-3 border-b border-gray-200">
                                <span class="font-semibold text-gray-700">${spec.nombre}:</span>
                                <span class="text-gray-600">${spec.valor}</span>
                            </div>
                        `).join('')}
                    </div>
                    <div class="space-y-3">
                        ${col2Specs.map(spec => `
                            <div class="flex justify-between py-3 border-b border-gray-200">
                                <span class="font-semibold text-gray-700">${spec.nombre}:</span>
                                <span class="text-gray-600">${spec.valor}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                // Si no hay especificaciones, mostrar datos básicos
                specsContainer.innerHTML = `
                    <div class="space-y-3">
                        <div class="flex justify-between py-3 border-b border-gray-200">
                            <span class="font-semibold text-gray-700">Marca:</span>
                            <span class="text-gray-600">${product.marca}</span>
                        </div>
                        <div class="flex justify-between py-3 border-b border-gray-200">
                            <span class="font-semibold text-gray-700">Categoría:</span>
                            <span class="text-gray-600">${product.categoria}</span>
                        </div>
                         <div class="flex justify-between py-3 border-b border-gray-200">
                            <span class="font-semibold text-gray-700">SKU:</span>
                            <span class="text-gray-600">${product.sku}</span>
                        </div>
                    </div>
                `;
            }

            // WhatsApp Button
            const whatsappMsg = `Hola, estoy interesado en el producto ${product.nombre} (Ref: ${product.sku})`;
            document.getElementById('whatsapp-btn').href = `https://wa.me/573001234567?text=${encodeURIComponent(whatsappMsg)}`;

            // Add to Cart Button Logic
            document.getElementById('add-to-cart-btn').onclick = () => {
                addToCart(product.id_producto, product.nombre, product.precio_actual, product.imagen_principal, currentQuantity);
            };

            // Favorite Button Setup
            const favBtn = document.getElementById('detail-fav-btn');
            favBtn.setAttribute('data-id', product.id_producto);

            // Re-init icons
            lucide.createIcons();

            // Update Favorites State
            if (typeof window.updateFavoritesUI === 'function') {
                window.updateFavoritesUI();
            }
        }

        // Cargar productos relacionados
        async function loadRelatedProducts(productId) {
            try {
                const response = await window.ProductService.getRelated(productId, 4);
                const container = document.getElementById('related-products');

                if (response.success && response.data.length > 0) {
                    // Usar la función global de renderizado de tarjetas
                    const cardsHtml = (await Promise.all(response.data.map(p => renderProductCard(p)))).join('');
                    container.innerHTML = cardsHtml;
                    lucide.createIcons();
                    // Update Favorites for related products
                    if (typeof window.updateFavoritesUI === 'function') {
                        window.updateFavoritesUI();
                    }
                } else {
                    document.getElementById('related-products-section').classList.add('hidden');
                }
            } catch (error) {
                console.error('Error loading related products:', error);
            }
        }

        // Helpers
        function showError() {
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('error-state').classList.remove('hidden');
        }

        function changeImage(url, index) {
            document.getElementById('main-image').src = url;
            currentImageIndex = index;

            document.querySelectorAll('.thumbnail').forEach((thumb, i) => {
                if (i === index) {
                    thumb.classList.add('active', 'border-primary');
                    thumb.classList.remove('border-gray-200');
                } else {
                    thumb.classList.remove('active', 'border-primary');
                    thumb.classList.add('border-gray-200');
                }
            });
        }

        function updateQuantity(change) {
            const input = document.getElementById('quantity-input');
            let newValue = parseInt(input.value) + change;
            if (newValue < 1) newValue = 1;
            // Check max stock if available in currentProduct
            if (currentProduct && newValue > currentProduct.stock) newValue = currentProduct.stock;

            input.value = newValue;
            currentQuantity = newValue;
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active', 'text-primary', 'border-primary');
                btn.classList.add('text-gray-600', 'border-transparent');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });

            document.getElementById(`tab-${tabName}`).classList.add('active', 'text-primary', 'border-primary');
            document.getElementById(`tab-${tabName}`).classList.remove('text-gray-600', 'border-transparent');
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
        }

        // Init
        document.addEventListener('DOMContentLoaded', loadProductDetails);
    </script>
</body>

</html>