<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Catálogo de Productos - Ceveco</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="../assets/img/logo.png">
    <!-- ✨ Sistema CSS Centralizado Profesional ✨ -->
    <link rel="stylesheet" href="../assets/css/main.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: { DEFAULT: 'var(--brand-red)', dark: '#d91b10', light: '#ff4d4d' },
                        secondary: { DEFAULT: 'var(--brand-blue-royal)', dark: '#002a5c', light: '#3366cc' },
                        accent: { DEFAULT: '#FFD23F', dark: '#E6BD38' },
                        dark: 'var(--brand-navy)',
                        white: 'var(--surface-white)',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        heading: ['Montserrat', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <!-- ✅ CSS eliminado - Ahora centralizado en main.css -->
</head>

<body class="bg-white text-gray-800 font-sans antialiased">

    <!-- Sticky Header -->
    <div id="navbar-root"></div>
    <!-- Hero Section -->
    <section id="category-hero" class="relative bg-gray-50 h-[200px] overflow-hidden hidden">
        <div class="absolute inset-0">
            <img id="hero-image" src="../assets/img/banner-hero/hero_main.jpg" alt="Banner"
                class="w-full h-full object-cover opacity-90">
            <div class="absolute inset-0 bg-gradient-to-r from-white/90 via-white/50 to-transparent"></div>
        </div>
        <div class="container mx-auto px-4 h-full relative flex items-center">
            <div class="max-w-xl space-y-4">
                <h1 id="hero-title" class="text-3xl md:text-4xl font-bold text-gray-900 leading-tight">
                    Catálogo <span class="text-primary">Ceveco</span>
                </h1>
                <p id="hero-subtitle" class="text-sm md:text-base text-gray-600">Encuentra los mejores productos para tu
                    hogar.</p>
            </div>
        </div>
    </section>

    <!-- Main Content: Catalog -->
    <main class="container mx-auto px-4 py-12">
        <div class="flex flex-col lg:flex-row gap-10">

            <!-- Sidebar Filters -->
            <!-- Sidebar Filters -->
            <div id="filters-sidebar-root" class="w-full lg:w-64 flex-shrink-0"></div>

            <!-- Product Grid -->
            <div class="flex-1">
                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-6 md:mb-8 gap-4">
                    <h2 id="catalog-title" class="text-xl md:text-2xl font-bold text-gray-900">Todos los Productos</h2>
                    <select id="sort-select"
                        class="w-full sm:w-auto border-none bg-gray-50 text-sm font-medium text-gray-600 rounded-lg px-4 py-2 focus:ring-2 focus:ring-primary/20 cursor-pointer">
                        <option value="relevancia">Ordenar por: Relevancia</option>
                        <option value="precio_asc">Precio: Menor a Mayor</option>
                        <option value="precio_desc">Precio: Mayor a Menor</option>
                    </select>
                </div>

                <!-- Loading State -->
                <div id="loading-state" class="hidden justify-center py-20">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
                </div>

                <!-- Empty State -->
                <div id="empty-state" class="hidden text-center py-20">
                    <div class="mx-auto w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                        <i data-lucide="search-x" class="w-8 h-8 text-gray-400"></i>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900">No se encontraron productos</h3>
                    <p class="text-gray-500">Intenta con otros filtros o términos de búsqueda.</p>
                </div>

                <div id="product-grid" class="grid grid-cols-2 lg:grid-cols-3 gap-3 md:gap-6">
                    <!-- Products rendered by JS -->
                </div>

                <!-- Pagination -->
                <div id="pagination" class="mt-12 flex justify-center hidden">
                    <nav class="flex items-center gap-2">
                        <button id="prev-page"
                            class="p-2 border border-gray-200 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i data-lucide="chevron-left" class="w-5 h-5"></i>
                        </button>
                        <span id="page-info" class="px-4 font-medium text-gray-600">Página 1</span>
                        <button id="next-page"
                            class="p-2 border border-gray-200 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i data-lucide="chevron-right" class="w-5 h-5"></i>
                        </button>
                    </nav>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <!-- Footer -->
    <div id="footer-root"></div>

    <!-- Cart Sidebar (Injected by main.js) -->

    <!-- Scripts -->
    <script src="../assets/js/config.js"></script>
    <!-- Modern Core Services -->
    <script src="../assets/js/utils/constants.js"></script>
    <script src="../assets/js/utils/helpers.js"></script>
    <script src="../assets/js/utils/storage.js"></script>
    <script src="../assets/js/config.js"></script>
    <script src="../assets/js/api/client.js"></script>
    <script src="../assets/js/services/auth.service.js"></script>
    <script src="../assets/js/services/products.service.js"></script>
    <script src="../assets/js/services/favorites.service.js"></script>
    <script src="../assets/js/core.js"></script>

    <!-- Legacy Compatibility Bridge -->
    <script>
        window.Utils = window.Helpers;
        window.formatPrice = window.Helpers.formatPrice;
    </script>
    <script type="module" src="../assets/js/auth/index.js"></script>
    <script type="module" src="../assets/js/favorites/index.js"></script>
    <script src="../assets/js/components/cart-sidebar.js"></script>
    <script src="../assets/js/app.js"></script>

    <script type="module">
        import { FiltersSidebar } from '../assets/js/components/filters-sidebar.js';

        // Inicializar iconos Lucide
        if (window.lucide) lucide.createIcons();

        // Estado global
        let currentPage = 1;
        let currentLimit = 12;
        let totalPages = 1;

        // Componente de filtros
        let filtersSidebar;

        // Función de búsqueda
        window.handleSearch = function () {
            const query = document.getElementById('search-input').value;
            if (query) {
                window.location.href = `productos.html?q=${encodeURIComponent(query)}`;
            }
        };

        // Obtener parámetros de URL
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                categoria: params.get('categoria'),
                q: params.get('q'),
                destacado: params.get('destacado')
            };
        }

        // Cargar productos
        async function loadProducts() {
            const grid = document.getElementById('product-grid');
            const loading = document.getElementById('loading-state');
            const empty = document.getElementById('empty-state');
            const pagination = document.getElementById('pagination');

            // Mostrar loading
            grid.innerHTML = '';
            loading.classList.remove('hidden');
            loading.classList.add('flex');
            empty.classList.add('hidden');
            pagination.classList.add('hidden');

            const params = getUrlParams();
            const sortValue = document.getElementById('sort-select').value;

            // Load filters via component if needed
            if (params.categoria && filtersSidebar) {
                // We check if the container is empty, or better, let the component handle logic.
                // However, component.loadDynamicFilters checks internally if it should render?
                // Actually the current component.loadDynamicFilters just renders.
                // To avoid re-fetching on every page load (pagination), we should check.
                // But for now, let's just checking if the container has content is a good proxy.
                const dynamicContainer = document.getElementById('dynamic-filters-container');
                if (dynamicContainer && !dynamicContainer.querySelector('.filter-group')) {
                    await filtersSidebar.loadDynamicFilters(params.categoria);
                }
            }

            // Preparar filtros
            const filters = {
                page: currentPage,
                limit: currentLimit
            };

            if (params.categoria) filters.categoria = params.categoria;
            if (params.q) filters.busqueda = params.q;
            if (params.destacado) filters.destacado = true;

            // Get values from component (using DOM directly for now as per refactor plan to match previous logic)
            // Or better, use the new method if available.
            if (filtersSidebar) {
                const values = filtersSidebar.getFilterValues();
                if (values.precioMin !== null) filters.precioMin = values.precioMin;
                if (values.precioMax !== null) filters.precioMax = values.precioMax;
                if (values.subcategoria) filters.subcategoria = values.subcategoria;
                if (values.atributos) filters.atributos = values.atributos;
            } else {
                // Fallback if component not ready (unlikely)
                const minInput = document.getElementById('price-min');
                const maxInput = document.getElementById('price-max');
                if (minInput && minInput.value) filters.precioMin = Number(minInput.value);
                if (maxInput && maxInput.value) filters.precioMax = Number(maxInput.value);
            }

            // Ordenamiento
            if (sortValue === 'precio_asc') {
                filters.orderBy = 'precio_actual';
                filters.orderDir = 'ASC';
            } else if (sortValue === 'precio_desc') {
                filters.orderBy = 'precio_actual';
                filters.orderDir = 'DESC';
            }

            try {
                // Actualizar UI según contexto
                updatePageHeader(params);

                let response;

                // Si hay búsqueda, usar endpoint de búsqueda
                if (params.q) {
                    response = await window.ProductService.search(params.q, filters);
                } else {
                    // Fetch productos normales
                    response = await window.ProductService.getAll(filters);
                }

                if (response.success && response.data.length > 0) {
                    // Renderizar productos usando la función global de main.js
                    const cardsHtml = (await Promise.all(response.data.map(product => renderProductCard(product)))).join('');
                    grid.innerHTML = cardsHtml;

                    // Actualizar paginación
                    totalPages = response.pagination.totalPages;
                    updatePagination();
                    pagination.classList.remove('hidden');

                    // Re-init iconos
                    lucide.createIcons();
                } else {
                    empty.classList.remove('hidden');
                    if (params.q) {
                        empty.querySelector('h3').textContent = 'No encontramos resultados';
                        empty.querySelector('p').textContent = `No hay productos que coincidan con "${params.q}". Intenta con otras palabras.`;
                    }
                }

                // Update Favorites State
                if (typeof window.updateFavoritesUI === 'function') {
                    window.updateFavoritesUI();
                }

            } catch (error) {
                console.error('Error loading products:', error);
                empty.classList.remove('hidden');
                empty.querySelector('h3').textContent = 'Error al cargar productos';
                empty.querySelector('p').textContent = 'Por favor intenta nuevamente más tarde.';
            } finally {
                loading.classList.add('hidden');
                loading.classList.remove('flex');
            }
        }

        // Actualizar encabezado de página
        function updatePageHeader(params) {
            const title = document.getElementById('catalog-title');
            const heroSection = document.getElementById('category-hero');
            const heroTitle = document.getElementById('hero-title');

            if (params.q) {
                title.textContent = `Resultados para "${params.q}"`;
                document.title = `Búsqueda: ${params.q} - Ceveco`;
                heroSection.classList.add('hidden');
            } else if (params.categoria) {
                const catName = formatCategoryName(params.categoria);
                title.textContent = catName;
                document.title = `${catName} - Ceveco`;

                // Mostrar Hero específico
                heroSection.classList.remove('hidden');
                heroTitle.innerHTML = `${catName}`;

                // Update Hero Image dynamically
                const heroImg = document.getElementById('hero-image');
                if (params.categoria === 'electro-hogar') {
                    heroImg.src = '../assets/img/banner-category/hero_electro.jpg';
                } else if (params.categoria === 'muebles') {
                    heroImg.src = '../assets/img/banner-category/hero_muebles.jpg';
                } else if (params.categoria === 'motos') {
                    heroImg.src = '../assets/img/banner-category/hero_motos.jpg';
                } else if (params.categoria === 'herramientas') {
                    heroImg.src = '../assets/img/banner-category/hero_herramientas.jpg';
                } else {
                    heroImg.src = '../assets/img/banner-hero/hero_main.jpg';
                }
            } else if (params.destacado) {
                title.textContent = 'Productos Destacados';
                document.title = 'Destacados - Ceveco';
                heroSection.classList.add('hidden');
            } else {
                title.textContent = 'Todos los Productos';
                document.title = 'Catálogo - Ceveco';
                heroSection.classList.add('hidden');
            }
        }

        function formatCategoryName(slug) {
            const names = {
                'electro-hogar': 'Electrodomésticos y Tecnología',
                'muebles': 'Muebles y Decoración',
                'motos': 'Movilidad y Transporte',
                'herramientas': 'Maquinaria y Herramientas'
            };
            return names[slug] || 'Productos';
        }


        // Paginación y Filtros
        function changePage(delta) {
            const newPage = currentPage + delta;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                loadProducts();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function updatePagination() {
            document.getElementById('page-info').textContent = `Página ${currentPage} de ${totalPages}`;
            document.getElementById('prev-page').disabled = currentPage === 1;
            document.getElementById('next-page').disabled = currentPage === totalPages;
        }

        function applyFilters() {
            currentPage = 1;
            // Clear Filters button update is handled by component internally? 
            // The component updates its own button.
            loadProducts();
        }

        // Init
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize Filter Component
            filtersSidebar = new FiltersSidebar('filters-sidebar-root', {
                onFilterChange: () => {
                    applyFilters();
                }
            });
            await filtersSidebar.init();

            // Add event listener for sort dropdown
            const sortSelect = document.getElementById('sort-select');
            if (sortSelect) sortSelect.addEventListener('change', applyFilters);

            // Add event listeners for pagination buttons
            const prevPage = document.getElementById('prev-page');
            const nextPage = document.getElementById('next-page');
            if (prevPage) prevPage.addEventListener('click', () => changePage(-1));
            if (nextPage) nextPage.addEventListener('click', () => changePage(1));

            // Load initial products
            loadProducts();
        });
    </script>
</body>

</html>