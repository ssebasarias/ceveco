<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Catálogo de Productos - Ceveco</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="../assets/img/logo.png">
    <!-- ✨ Sistema CSS Centralizado Profesional ✨ -->
    <link rel="stylesheet" href="../assets/css/main.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: { DEFAULT: 'var(--brand-red)', dark: '#d91b10', light: '#ff4d4d' },
                        secondary: { DEFAULT: 'var(--brand-blue-royal)', dark: '#002a5c', light: '#3366cc' },
                        accent: { DEFAULT: '#FFD23F', dark: '#E6BD38' },
                        dark: 'var(--brand-navy)',
                        white: 'var(--surface-white)',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        heading: ['Montserrat', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <!-- ✅ CSS eliminado - Ahora centralizado en main.css -->
</head>

<body class="bg-white text-gray-800 font-sans antialiased">

    <!-- Sticky Header -->
    <div id="navbar-root"></div>
    <!-- Hero Section -->
    <section id="category-hero" class="relative bg-gray-50 h-[200px] overflow-hidden hidden">
        <div class="absolute inset-0">
            <img id="hero-image" src="../assets/img/banner-hero/hero_main.jpg" alt="Banner"
                class="w-full h-full object-cover opacity-90">
            <div class="absolute inset-0 bg-gradient-to-r from-white/90 via-white/50 to-transparent"></div>
        </div>
        <div class="container mx-auto px-4 h-full relative flex items-center">
            <div class="max-w-xl space-y-4">
                <h1 id="hero-title" class="text-3xl md:text-4xl font-bold text-gray-900 leading-tight">
                    Catálogo <span class="text-primary">Ceveco</span>
                </h1>
                <p id="hero-subtitle" class="text-sm md:text-base text-gray-600">Encuentra los mejores productos para tu
                    hogar.</p>
            </div>
        </div>
    </section>

    <!-- Main Content: Catalog -->
    <main class="container mx-auto px-4 py-12">
        <div class="flex flex-col lg:flex-row gap-10">

            <!-- Sidebar Filters -->
            <aside class="w-full lg:w-64 flex-shrink-0">
                <!-- Mobile Toggle -->
                <button onclick="document.getElementById('filters-wrapper').classList.toggle('hidden')"
                    class="filters-toggle-mobile lg:hidden mb-4">
                    <span class="flex items-center gap-2">
                        <i data-lucide="sliders-horizontal" class="w-5 h-5"></i>
                        Filtros
                    </span>
                    <i data-lucide="chevron-down" class="w-5 h-5"></i>
                </button>

                <!-- Filters Container -->
                <div id="filters-wrapper" class="hidden lg:block filters-sidebar">
                    <!-- Header -->
                    <div class="filters-header">
                        <h3>
                            <i data-lucide="sliders-horizontal" class="w-5 h-5 filters-header-icon"></i>
                            Filtros
                        </h3>
                        <button onclick="clearAllFilters()" class="btn-clear-filters" id="clear-filters-btn"
                            style="display: none;">
                            Limpiar
                        </button>
                    </div>

                    <!-- Dynamic Attribute Filters -->
                    <div id="dynamic-filters-container">

                        <!-- Subcategorías -->
                        <div class="filter-group mb-6">
                            <h3 class="font-bold text-lg mb-3 text-gray-900">Subcategorías</h3>
                            <div class="space-y-2">
                                <label class="flex items-center gap-3 cursor-pointer group">
                                    <div class="relative flex items-center">
                                        <input type="checkbox"
                                            class="peer appearance-none w-5 h-5 border border-gray-300 rounded checked:bg-primary checked:border-primary transition-colors">
                                        <i data-lucide="check"
                                            class="absolute inset-0 w-3.5 h-3.5 m-auto text-white opacity-0 peer-checked:opacity-100 pointer-events-none stroke-[3px]"></i>
                                    </div>
                                    <span class="text-gray-600 group-hover:text-gray-900">Deportivas</span>
                                </label>
                                <label class="flex items-center gap-3 cursor-pointer group">
                                    <div class="relative flex items-center">
                                        <input type="checkbox"
                                            class="peer appearance-none w-5 h-5 border border-gray-300 rounded checked:bg-primary checked:border-primary transition-colors">
                                        <i data-lucide="check"
                                            class="absolute inset-0 w-3.5 h-3.5 m-auto text-white opacity-0 peer-checked:opacity-100 pointer-events-none stroke-[3px]"></i>
                                    </div>
                                    <span class="text-gray-600 group-hover:text-gray-900">Touring</span>
                                </label>
                                <label class="flex items-center gap-3 cursor-pointer group">
                                    <div class="relative flex items-center">
                                        <input type="checkbox"
                                            class="peer appearance-none w-5 h-5 border border-gray-300 rounded checked:bg-primary checked:border-primary transition-colors">
                                        <i data-lucide="check"
                                            class="absolute inset-0 w-3.5 h-3.5 m-auto text-white opacity-0 peer-checked:opacity-100 pointer-events-none stroke-[3px]"></i>
                                    </div>
                                    <span class="text-gray-600 group-hover:text-gray-900">Scooters</span>
                                </label>
                            </div>
                        </div>

                        <!-- Cilindraje -->
                        <div class="filter-group mb-6">
                            <h3 class="font-bold text-lg mb-3 text-gray-900">Cilindraje</h3>
                            <div class="space-y-2">
                                <label class="flex items-center gap-3 cursor-pointer group">
                                    <div class="relative flex items-center">
                                        <input type="checkbox"
                                            class="peer appearance-none w-5 h-5 border border-gray-300 rounded checked:bg-primary checked:border-primary transition-colors">
                                        <i data-lucide="check"
                                            class="absolute inset-0 w-3.5 h-3.5 m-auto text-white opacity-0 peer-checked:opacity-100 pointer-events-none stroke-[3px]"></i>
                                    </div>
                                    <span class="text-gray-600 group-hover:text-gray-900">125cc</span>
                                </label>
                                <label class="flex items-center gap-3 cursor-pointer group">
                                    <div class="relative flex items-center">
                                        <input type="checkbox"
                                            class="peer appearance-none w-5 h-5 border border-gray-300 rounded checked:bg-primary checked:border-primary transition-colors">
                                        <i data-lucide="check"
                                            class="absolute inset-0 w-3.5 h-3.5 m-auto text-white opacity-0 peer-checked:opacity-100 pointer-events-none stroke-[3px]"></i>
                                    </div>
                                    <span class="text-gray-600 group-hover:text-gray-900">150cc</span>
                                </label>
                                <label class="flex items-center gap-3 cursor-pointer group">
                                    <div class="relative flex items-center">
                                        <input type="checkbox"
                                            class="peer appearance-none w-5 h-5 border border-gray-300 rounded checked:bg-primary checked:border-primary transition-colors">
                                        <i data-lucide="check"
                                            class="absolute inset-0 w-3.5 h-3.5 m-auto text-white opacity-0 peer-checked:opacity-100 pointer-events-none stroke-[3px]"></i>
                                    </div>
                                    <span class="text-gray-600 group-hover:text-gray-900">200cc</span>
                                </label>
                                <label class="flex items-center gap-3 cursor-pointer group">
                                    <div class="relative flex items-center">
                                        <input type="checkbox"
                                            class="peer appearance-none w-5 h-5 border border-gray-300 rounded checked:bg-primary checked:border-primary transition-colors">
                                        <i data-lucide="check"
                                            class="absolute inset-0 w-3.5 h-3.5 m-auto text-white opacity-0 peer-checked:opacity-100 pointer-events-none stroke-[3px]"></i>
                                    </div>
                                    <span class="text-gray-600 group-hover:text-gray-900">250cc</span>
                                </label>
                            </div>
                        </div>

                        <!-- Color -->
                        <div class="filter-group mb-6">
                            <h3 class="font-bold text-lg mb-3 text-gray-900">Color</h3>
                            <div class="space-y-2">
                                <label class="flex items-center gap-3 cursor-pointer group">
                                    <div class="relative flex items-center">
                                        <input type="checkbox"
                                            class="peer appearance-none w-5 h-5 border border-gray-300 rounded checked:bg-primary checked:border-primary transition-colors">
                                        <i data-lucide="check"
                                            class="absolute inset-0 w-3.5 h-3.5 m-auto text-white opacity-0 peer-checked:opacity-100 pointer-events-none stroke-[3px]"></i>
                                    </div>
                                    <span class="text-gray-600 group-hover:text-gray-900">Rojo</span>
                                </label>
                                <label class="flex items-center gap-3 cursor-pointer group">
                                    <div class="relative flex items-center">
                                        <input type="checkbox"
                                            class="peer appearance-none w-5 h-5 border border-gray-300 rounded checked:bg-primary checked:border-primary transition-colors">
                                        <i data-lucide="check"
                                            class="absolute inset-0 w-3.5 h-3.5 m-auto text-white opacity-0 peer-checked:opacity-100 pointer-events-none stroke-[3px]"></i>
                                    </div>
                                    <span class="text-gray-600 group-hover:text-gray-900">Negro</span>
                                </label>
                                <label class="flex items-center gap-3 cursor-pointer group">
                                    <div class="relative flex items-center">
                                        <input type="checkbox"
                                            class="peer appearance-none w-5 h-5 border border-gray-300 rounded checked:bg-primary checked:border-primary transition-colors">
                                        <i data-lucide="check"
                                            class="absolute inset-0 w-3.5 h-3.5 m-auto text-white opacity-0 peer-checked:opacity-100 pointer-events-none stroke-[3px]"></i>
                                    </div>
                                    <span class="text-gray-600 group-hover:text-gray-900">Azul</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Price Filter -->
                    <div class="filter-group">
                        <h3 class="font-bold text-lg mb-4 text-gray-900">Precio</h3>
                        <div class="px-1">
                            <div class="relative w-full h-1 bg-gray-200 rounded-full mb-6 mt-2">
                                <div class="absolute h-full bg-primary rounded-full" style="left: 0%; width: 100%;">
                                </div>
                                <div
                                    class="absolute h-5 w-5 bg-primary rounded-full shadow-md -top-2 -right-1 cursor-pointer border-2 border-white">
                                </div>
                            </div>
                            <div class="flex justify-between items-center text-gray-900 font-medium">
                                <span>$1.000,000</span>
                                <span>$3.000,000</span>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Product Grid -->
            <div class="flex-1">
                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-6 md:mb-8 gap-4">
                    <h2 id="catalog-title" class="text-xl md:text-2xl font-bold text-gray-900">Todos los Productos</h2>
                    <select id="sort-select" onchange="applyFilters()"
                        class="w-full sm:w-auto border-none bg-gray-50 text-sm font-medium text-gray-600 rounded-lg px-4 py-2 focus:ring-2 focus:ring-primary/20 cursor-pointer">
                        <option value="relevancia">Ordenar por: Relevancia</option>
                        <option value="precio_asc">Precio: Menor a Mayor</option>
                        <option value="precio_desc">Precio: Mayor a Menor</option>
                    </select>
                </div>

                <!-- Loading State -->
                <div id="loading-state" class="hidden justify-center py-20">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
                </div>

                <!-- Empty State -->
                <div id="empty-state" class="hidden text-center py-20">
                    <div class="mx-auto w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                        <i data-lucide="search-x" class="w-8 h-8 text-gray-400"></i>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900">No se encontraron productos</h3>
                    <p class="text-gray-500">Intenta con otros filtros o términos de búsqueda.</p>
                </div>

                <div id="product-grid" class="grid grid-cols-2 lg:grid-cols-3 gap-3 md:gap-6">
                    <!-- Products rendered by JS -->
                </div>

                <!-- Pagination -->
                <div id="pagination" class="mt-12 flex justify-center hidden">
                    <nav class="flex items-center gap-2">
                        <button id="prev-page" onclick="changePage(-1)"
                            class="p-2 border border-gray-200 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i data-lucide="chevron-left" class="w-5 h-5"></i>
                        </button>
                        <span id="page-info" class="px-4 font-medium text-gray-600">Página 1</span>
                        <button id="next-page" onclick="changePage(1)"
                            class="p-2 border border-gray-200 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i data-lucide="chevron-right" class="w-5 h-5"></i>
                        </button>
                    </nav>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <!-- Footer -->
    <div id="footer-root"></div>

    <!-- Cart Sidebar (Injected by main.js) -->

    <!-- Scripts -->
    <script src="../assets/js/config.js"></script>
    <script src="../assets/js/utils/utils.js"></script>
    <script src="../assets/js/api/productos.api.js"></script>
    <script type="module" src="../assets/js/auth/index.js"></script>
    <script type="module" src="../assets/js/favorites/index.js"></script>
    <script src="../assets/js/components/cart-sidebar.js"></script>
    <script src="../assets/js/app.js"></script>

    <script>
        // Inicializar iconos Lucide
        lucide.createIcons();

        // Estado global
        let currentPage = 1;
        let currentLimit = 12;
        let totalPages = 1;

        // Función de búsqueda
        function handleSearch() {
            const query = document.getElementById('search-input').value;
            if (query) {
                window.location.href = `productos.html?q=${encodeURIComponent(query)}`;
            }
        }

        // Obtener parámetros de URL
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                categoria: params.get('categoria'),
                q: params.get('q'),
                destacado: params.get('destacado')
            };
        }

        // Cargar filtros dinámicos
        async function loadDynamicFilters(categoria) {
            const container = document.getElementById('dynamic-filters-container');
            container.innerHTML = '<div class="filter-loading"><div class="filter-loading-spinner"></div></div>';

            // Función para obtener icono según el nombre del atributo
            const getIconForAttribute = (nombre) => {
                const iconMap = {
                    'cilindraje': 'gauge',
                    'tipo de motor': 'zap',
                    'tipo de frenos': 'disc',
                    'color': 'palette',
                    'material': 'layers',
                    'dimensiones': 'maximize-2',
                    'capacidad': 'package',
                    'potencia': 'battery-charging',
                    'voltaje': 'zap',
                    'peso': 'weight',
                    'tamaño': 'maximize',
                    'marca': 'tag',
                    'modelo': 'box',
                    'año': 'calendar',
                };

                const lowerName = nombre.toLowerCase();
                for (const [key, icon] of Object.entries(iconMap)) {
                    if (lowerName.includes(key)) {
                        return icon;
                    }
                }
                return 'settings'; // Icono por defecto
            };

            try {
                const response = await ProductosAPI.getFilters(categoria);
                if (response.success && response.data) {
                    const attributes = response.data;

                    if (attributes.length === 0) {
                        container.innerHTML = '';
                        return;
                    }

                    const html = attributes.map(attr => {
                        const uniqueValues = [...new Set(attr.valores)].filter(v => v !== null);

                        if (uniqueValues.length === 0) return '';

                        const icon = getIconForAttribute(attr.nombre);

                        return `
                            <div class="filter-group">
                                <h4 class="filter-group-title">
                                    <i data-lucide="${icon}" class="w-4 h-4"></i>
                                    ${attr.nombre}
                                    ${attr.unidad ? `<span class="filter-group-badge">${attr.unidad}</span>` : ''}
                                </h4>
                                <div class="filter-options">
                                    ${uniqueValues.map(val => {
                            const safeVal = String(val).replace(/"/g, '&quot;');
                            const filterId = `filter-${attr.id_atributo}-${safeVal.replace(/\s+/g, '-').replace(/[^\w-]/g, '')}`;
                            return `
                                            <label class="filter-option" for="${filterId}">
                                                <input 
                                                    type="checkbox" 
                                                    id="${filterId}"
                                                    name="attr_${attr.id_atributo}" 
                                                    value="${safeVal}" 
                                                    onchange="applyFilters()" 
                                                    class="filter-checkbox">
                                                <span class="filter-label">${val}</span>
                                            </label>
                                        `;
                        }).join('')}
                                </div>
                            </div>
                        `;
                    }).filter(html => html !== '').join('');

                    container.innerHTML = html;

                    // Re-inicializar iconos de Lucide
                    lucide.createIcons();
                }
            } catch (err) {
                console.error('Error loading filters', err);
                container.innerHTML = '<div class="filter-group"><p class="text-sm text-gray-500">No se pudieron cargar los filtros</p></div>';
            }
        }

        // Cargar productos
        async function loadProducts() {
            const grid = document.getElementById('product-grid');
            const loading = document.getElementById('loading-state');
            const empty = document.getElementById('empty-state');
            const pagination = document.getElementById('pagination');

            // Mostrar loading
            grid.innerHTML = '';
            loading.classList.remove('hidden');
            loading.classList.add('flex');
            empty.classList.add('hidden');
            pagination.classList.add('hidden');

            const params = getUrlParams();
            const sortValue = document.getElementById('sort-select').value;
            const minPrice = null;
            const maxPrice = null;

            // Load filters ONLY if not already loaded or if needed
            if (params.categoria && document.getElementById('dynamic-filters-container').innerHTML.trim() === '') {
                loadDynamicFilters(params.categoria);
            }

            // Preparar filtros
            const filters = {
                page: currentPage,
                limit: currentLimit
            };

            if (params.categoria) filters.categoria = params.categoria;
            if (params.q) filters.busqueda = params.q;
            if (params.destacado) filters.destacado = true;
            if (minPrice) filters.precioMin = minPrice;
            if (maxPrice) filters.precioMax = maxPrice;

            // Collect dynamic attributes
            const selectedAttrs = {};
            document.querySelectorAll('#dynamic-filters-container input:checked').forEach(input => {
                const attrId = input.name.replace('attr_', '');
                if (!selectedAttrs[attrId]) selectedAttrs[attrId] = [];
                selectedAttrs[attrId].push(input.value);
            });

            if (Object.keys(selectedAttrs).length > 0) {
                filters.atributos = JSON.stringify(selectedAttrs);
            }

            // Ordenamiento
            if (sortValue === 'precio_asc') {
                filters.orderBy = 'precio_actual';
                filters.orderDir = 'ASC';
            } else if (sortValue === 'precio_desc') {
                filters.orderBy = 'precio_actual';
                filters.orderDir = 'DESC';
            }

            try {
                // Actualizar UI según contexto
                updatePageHeader(params);

                let response;

                // Si hay búsqueda, usar endpoint de búsqueda
                if (params.q) {
                    response = await ProductosAPI.buscar(params.q, filters);
                } else {
                    // Fetch productos normales
                    response = await ProductosAPI.getAll(filters);
                }

                if (response.success && response.data.length > 0) {
                    // Renderizar productos usando la función global de main.js
                    const cardsHtml = (await Promise.all(response.data.map(product => renderProductCard(product)))).join('');
                    grid.innerHTML = cardsHtml;

                    // Actualizar paginación
                    totalPages = response.pagination.totalPages;
                    updatePagination();
                    pagination.classList.remove('hidden');

                    // Re-init iconos
                    lucide.createIcons();
                } else {
                    empty.classList.remove('hidden');
                    if (params.q) {
                        empty.querySelector('h3').textContent = 'No encontramos resultados';
                        empty.querySelector('p').textContent = `No hay productos que coincidan con "${params.q}". Intenta con otras palabras.`;
                    }
                }

                // Update Favorites State
                if (typeof window.updateFavoritesUI === 'function') {
                    window.updateFavoritesUI();
                }

            } catch (error) {
                console.error('Error loading products:', error);
                empty.classList.remove('hidden');
                empty.querySelector('h3').textContent = 'Error al cargar productos';
                empty.querySelector('p').textContent = 'Por favor intenta nuevamente más tarde.';
            } finally {
                loading.classList.add('hidden');
                loading.classList.remove('flex');
            }
        }

        // Actualizar encabezado de página
        function updatePageHeader(params) {
            const title = document.getElementById('catalog-title');
            const heroSection = document.getElementById('category-hero');
            const heroTitle = document.getElementById('hero-title');

            if (params.q) {
                title.textContent = `Resultados para "${params.q}"`;
                document.title = `Búsqueda: ${params.q} - Ceveco`;
                heroSection.classList.add('hidden');
            } else if (params.categoria) {
                const catName = formatCategoryName(params.categoria);
                title.textContent = catName;
                document.title = `${catName} - Ceveco`;

                // Mostrar Hero específico
                heroSection.classList.remove('hidden');
                heroTitle.innerHTML = `${catName}`;

                // Update Hero Image dynamically
                const heroImg = document.getElementById('hero-image');
                if (params.categoria === 'electro-hogar') {
                    heroImg.src = '../assets/img/banner-category/hero_electro.jpg';
                } else if (params.categoria === 'muebles') {
                    heroImg.src = '../assets/img/banner-category/hero_muebles.jpg';
                } else if (params.categoria === 'motos') {
                    heroImg.src = '../assets/img/banner-category/hero_motos.jpg';
                } else if (params.categoria === 'herramientas') {
                    heroImg.src = '../assets/img/banner-category/hero_herramientas.jpg';
                } else {
                    heroImg.src = '../assets/img/banner-hero/hero_main.jpg';
                }
            } else if (params.destacado) {
                title.textContent = 'Productos Destacados';
                document.title = 'Destacados - Ceveco';
                heroSection.classList.add('hidden');
            } else {
                title.textContent = 'Todos los Productos';
                document.title = 'Catálogo - Ceveco';
                heroSection.classList.add('hidden');
            }
        }

        function formatCategoryName(slug) {
            const names = {
                'electro-hogar': 'Electrodomésticos y Tecnología',
                'muebles': 'Muebles y Decoración',
                'motos': 'Movilidad y Transporte',
                'herramientas': 'Maquinaria y Herramientas'
            };
            return names[slug] || 'Productos';
        }


        // Paginación y Filtros
        function changePage(delta) {
            const newPage = currentPage + delta;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                loadProducts();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function updatePagination() {
            document.getElementById('page-info').textContent = `Página ${currentPage} de ${totalPages}`;
            document.getElementById('prev-page').disabled = currentPage === 1;
            document.getElementById('next-page').disabled = currentPage === totalPages;
        }

        function applyFilters() {
            currentPage = 1;
            updateClearFiltersButton();
            loadProducts();
        }

        // Limpiar todos los filtros
        function clearAllFilters() {
            // Limpiar checkboxes de atributos
            document.querySelectorAll('#dynamic-filters-container input[type="checkbox"]:checked').forEach(checkbox => {
                checkbox.checked = false;
            });

            // Limpiar precio
            // document.getElementById('min-price').value = '';
            // document.getElementById('max-price').value = '';

            // Ocultar botón de limpiar
            updateClearFiltersButton();

            // Aplicar filtros (sin filtros)
            applyFilters();
        }

        // Actualizar visibilidad del botón de limpiar filtros
        function updateClearFiltersButton() {
            const hasActiveFilters =
                document.querySelectorAll('#dynamic-filters-container input[type="checkbox"]:checked').length > 0;

            const clearBtn = document.getElementById('clear-filters-btn');
            if (clearBtn) {
                clearBtn.style.display = hasActiveFilters ? 'inline-block' : 'none';
            }
        }

        // Init
        document.addEventListener('DOMContentLoaded', loadProducts);
    </script>
</body>

</html>