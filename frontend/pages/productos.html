<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Catálogo de Productos - Ceveco</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="../assets/img/logo.png">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0056b3',
                        dark: '#1F2937',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .group:hover .mega-menu {
            display: block;
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
    </style>
</head>

<body class="bg-white text-gray-800 font-sans antialiased">

    <!-- Sticky Header -->
    <div id="navbar-root"></div>
    <!-- Hero Section -->
    <section id="category-hero" class="relative bg-gray-50 h-[300px] overflow-hidden hidden">
        <div class="absolute inset-0">
            <img id="hero-image" src="../assets/img/hero.png" alt="Banner"
                class="w-full h-full object-cover opacity-90">
            <div class="absolute inset-0 bg-gradient-to-r from-white/90 via-white/50 to-transparent"></div>
        </div>
        <div class="container mx-auto px-4 h-full relative flex items-center">
            <div class="max-w-xl space-y-4">
                <h1 id="hero-title" class="text-4xl md:text-5xl font-bold text-gray-900 leading-tight">
                    Catálogo <span class="text-primary">Ceveco</span>
                </h1>
                <p id="hero-subtitle" class="text-lg text-gray-600">Encuentra los mejores productos para tu hogar.</p>
            </div>
        </div>
    </section>

    <!-- Main Content: Catalog -->
    <main class="container mx-auto px-4 py-12">
        <div class="flex flex-col lg:flex-row gap-10">

            <!-- Sidebar Filters -->
            <aside class="w-full lg:w-64 flex-shrink-0 space-y-6">
                <div>
                    <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                        <i data-lucide="sliders-horizontal" class="w-5 h-5"></i> Filtros
                    </h3>

                    <!-- Categoría -->
                    <div class="border-b border-gray-100 py-4">
                        <h4 class="font-semibold text-gray-700 mb-3">Categorías</h4>
                        <ul class="space-y-2 text-sm text-gray-600">
                            <li><a href="productos.html?categoria=electro-hogar"
                                    class="hover:text-primary flex items-center gap-2">
                                    <span class="w-2 h-2 rounded-full bg-gray-300"></span> Electro Hogar
                                </a></li>
                            <li><a href="productos.html?categoria=muebles"
                                    class="hover:text-primary flex items-center gap-2">
                                    <span class="w-2 h-2 rounded-full bg-gray-300"></span> Muebles
                                </a></li>
                            <li><a href="productos.html?categoria=motos"
                                    class="hover:text-primary flex items-center gap-2">
                                    <span class="w-2 h-2 rounded-full bg-gray-300"></span> Motos
                                </a></li>
                            <li><a href="productos.html?categoria=herramientas"
                                    class="hover:text-primary flex items-center gap-2">
                                    <span class="w-2 h-2 rounded-full bg-gray-300"></span> Herramientas
                                </a></li>
                        </ul>
                    </div>

                    <!-- Precio -->
                    <div class="border-b border-gray-100 py-4">
                        <h4 class="font-semibold text-gray-700 mb-3">Precio</h4>
                        <div class="flex items-center gap-2 text-sm">
                            <input type="number" id="min-price" placeholder="Min"
                                class="w-20 px-2 py-1 border border-gray-200 rounded">
                            <span>-</span>
                            <input type="number" id="max-price" placeholder="Max"
                                class="w-20 px-2 py-1 border border-gray-200 rounded">
                        </div>
                        <button onclick="applyFilters()"
                            class="mt-2 text-xs bg-primary text-white px-3 py-1 rounded hover:bg-blue-700 transition-colors">Aplicar</button>
                    </div>
                </div>
            </aside>

            <!-- Product Grid -->
            <div class="flex-1">
                <div class="flex items-center justify-between mb-8">
                    <h2 id="catalog-title" class="text-2xl font-bold text-gray-900">Todos los Productos</h2>
                    <select id="sort-select" onchange="applyFilters()"
                        class="border-none bg-gray-50 text-sm font-medium text-gray-600 rounded-lg px-4 py-2 focus:ring-2 focus:ring-primary/20 cursor-pointer">
                        <option value="relevancia">Ordenar por: Relevancia</option>
                        <option value="precio_asc">Precio: Menor a Mayor</option>
                        <option value="precio_desc">Precio: Mayor a Menor</option>
                    </select>
                </div>

                <!-- Loading State -->
                <div id="loading-state" class="hidden flex justify-center py-20">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
                </div>

                <!-- Empty State -->
                <div id="empty-state" class="hidden text-center py-20">
                    <div class="mx-auto w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                        <i data-lucide="search-x" class="w-8 h-8 text-gray-400"></i>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900">No se encontraron productos</h3>
                    <p class="text-gray-500">Intenta con otros filtros o términos de búsqueda.</p>
                </div>

                <div id="product-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Products rendered by JS -->
                </div>

                <!-- Pagination -->
                <div id="pagination" class="mt-12 flex justify-center hidden">
                    <nav class="flex items-center gap-2">
                        <button id="prev-page" onclick="changePage(-1)"
                            class="p-2 border border-gray-200 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i data-lucide="chevron-left" class="w-5 h-5"></i>
                        </button>
                        <span id="page-info" class="px-4 font-medium text-gray-600">Página 1</span>
                        <button id="next-page" onclick="changePage(1)"
                            class="p-2 border border-gray-200 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i data-lucide="chevron-right" class="w-5 h-5"></i>
                        </button>
                    </nav>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <!-- Footer -->
    <div id="footer-root"></div>

    <!-- Cart Sidebar (Injected by main.js) -->

    <!-- Scripts -->
    <script src="../assets/js/config.js"></script>
    <script src="../assets/js/utils/utils.js"></script>
    <script src="../assets/js/api/productos.api.js"></script>
    <script type="module" src="../assets/js/auth/index.js"></script>
    <script src="../assets/js/components/cart-sidebar.js"></script>
    <script src="../assets/js/app.js"></script>

    <script>
        // Inicializar iconos Lucide
        lucide.createIcons();

        // Estado global
        let currentPage = 1;
        let currentLimit = 12;
        let totalPages = 1;

        // Función de búsqueda
        function handleSearch() {
            const query = document.getElementById('search-input').value;
            if (query) {
                window.location.href = `productos.html?q=${encodeURIComponent(query)}`;
            }
        }

        // Obtener parámetros de URL
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                categoria: params.get('categoria'),
                q: params.get('q'),
                destacado: params.get('destacado')
            };
        }

        // Cargar productos
        async function loadProducts() {
            const grid = document.getElementById('product-grid');
            const loading = document.getElementById('loading-state');
            const empty = document.getElementById('empty-state');
            const pagination = document.getElementById('pagination');

            // Mostrar loading
            grid.innerHTML = '';
            loading.classList.remove('hidden');
            empty.classList.add('hidden');
            pagination.classList.add('hidden');

            const params = getUrlParams();
            const sortValue = document.getElementById('sort-select').value;
            const minPrice = document.getElementById('min-price').value;
            const maxPrice = document.getElementById('max-price').value;

            // Preparar filtros
            const filters = {
                page: currentPage,
                limit: currentLimit
            };

            if (params.categoria) filters.categoria = params.categoria;
            if (params.q) filters.busqueda = params.q;
            if (params.destacado) filters.destacado = true;
            if (minPrice) filters.precioMin = minPrice;
            if (maxPrice) filters.precioMax = maxPrice;

            // Ordenamiento
            if (sortValue === 'precio_asc') {
                filters.orderBy = 'precio_actual';
                filters.orderDir = 'ASC';
            } else if (sortValue === 'precio_desc') {
                filters.orderBy = 'precio_actual';
                filters.orderDir = 'DESC';
            }

            try {
                // Actualizar UI según contexto
                updatePageHeader(params);

                // Fetch productos
                const response = await ProductosAPI.getAll(filters);

                loading.classList.add('hidden');

                if (response.success && response.data.length > 0) {
                    // Renderizar productos usando la función global de main.js
                    const cardsHtml = (await Promise.all(response.data.map(product => renderProductCard(product)))).join('');
                    grid.innerHTML = cardsHtml;

                    // Actualizar paginación
                    totalPages = response.pagination.totalPages;
                    updatePagination();
                    pagination.classList.remove('hidden');

                    // Re-init iconos
                    lucide.createIcons();
                } else {
                    empty.classList.remove('hidden');
                }

            } catch (error) {
                console.error('Error loading products:', error);
                loading.classList.add('hidden');
                empty.classList.remove('hidden');
                empty.querySelector('h3').textContent = 'Error al cargar productos';
                empty.querySelector('p').textContent = 'Por favor intenta nuevamente más tarde.';
            }
        }

        // Actualizar encabezado de página
        function updatePageHeader(params) {
            const title = document.getElementById('catalog-title');
            const heroSection = document.getElementById('category-hero');
            const heroTitle = document.getElementById('hero-title');

            if (params.q) {
                title.textContent = `Resultados para "${params.q}"`;
                document.title = `Búsqueda: ${params.q} - Ceveco`;
                heroSection.classList.add('hidden');
            } else if (params.categoria) {
                const catName = formatCategoryName(params.categoria);
                title.textContent = catName;
                document.title = `${catName} - Ceveco`;

                // Mostrar Hero específico
                heroSection.classList.remove('hidden');
                heroTitle.innerHTML = `${catName}`;
            } else if (params.destacado) {
                title.textContent = 'Productos Destacados';
                document.title = 'Destacados - Ceveco';
                heroSection.classList.add('hidden');
            } else {
                title.textContent = 'Todos los Productos';
                document.title = 'Catálogo - Ceveco';
                heroSection.classList.add('hidden');
            }
        }

        function formatCategoryName(slug) {
            const names = {
                'electro-hogar': 'Electro Hogar',
                'muebles': 'Muebles y Organización',
                'motos': 'Motos',
                'herramientas': 'Herramientas STIHL'
            };
            return names[slug] || 'Productos';
        }


        // Paginación y Filtros
        function changePage(delta) {
            const newPage = currentPage + delta;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                loadProducts();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function updatePagination() {
            document.getElementById('page-info').textContent = `Página ${currentPage} de ${totalPages}`;
            document.getElementById('prev-page').disabled = currentPage === 1;
            document.getElementById('next-page').disabled = currentPage === totalPages;
        }

        function applyFilters() {
            currentPage = 1;
            loadProducts();
        }

        // Init
        document.addEventListener('DOMContentLoaded', loadProducts);
    </script>
</body>

</html>